---
# Validation d'External DNS

- name: "ğŸ” VÃ©rification du statut du pod External DNS"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: external-dns
    label_selectors:
    - app.kubernetes.io/name=external-dns
  register: external_dns_pods

- name: "ğŸ“Š Validation du pod External DNS"
  assert:
    that:
    - external_dns_pods.resources | length > 0
    - external_dns_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == external_dns_pods.resources | length
    fail_msg: "âŒ Le pod External DNS n'est pas en Ã©tat Running"
    success_msg: "âœ… Le pod External DNS est en Ã©tat Running"

- name: "ğŸ” VÃ©rification des logs External DNS"
  shell: kubectl logs -n external-dns -l app.kubernetes.io/name=external-dns --tail=5
  register: external_dns_logs
  changed_when: false

- name: "ğŸ“‹ Affichage des logs rÃ©cents"
  debug:
    msg: |
      ğŸ“‹ Logs rÃ©cents d'External DNS:
      {{ external_dns_logs.stdout | default('Aucun log disponible') }}

- name: "âœ… Validation complÃ¨te d'External DNS"
  debug:
    msg: |
      ğŸ‰ External DNS validÃ© avec succÃ¨s!

      ğŸ“Š Statut:
      - Pod en cours: {{ external_dns_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}/{{ external_dns_pods.resources | length }}
      - Provider: Scaleway
      - Domaines surveillÃ©s: keltio.fr

      ğŸŒ FonctionnalitÃ©s:
      - Synchronisation automatique des enregistrements DNS
      - Support des Ingress et Services LoadBalancer
      - TTL configurable par annotation

      ğŸš€ PrÃªt pour la gestion automatique du DNS!
