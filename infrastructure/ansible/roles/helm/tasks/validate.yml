---
# Validation de l'installation Helm

- name: "Test de la commande helm version"
  command: helm version
  register: helm_version_output
  environment:
    KUBECONFIG: "{{ k3s_config_file | default('/etc/rancher/k3s/k3s.yaml') }}"
  become: true
  changed_when: false

- name: "Validation de la version Helm"
  assert:
    that:
    - helm_version_output.rc == 0
    - helm_version in helm_version_output.stdout
    fail_msg: "La version Helm installÃ©e ne correspond pas Ã  {{ helm_version }}"
    success_msg: "Helm {{ helm_version }} installÃ© avec succÃ¨s"

- name: "Test de connexion au cluster Kubernetes"
  command: helm list --all-namespaces
  register: helm_cluster_test
  environment:
    KUBECONFIG: "{{ k3s_config_file | default('/etc/rancher/k3s/k3s.yaml') }}"
  become: true
  changed_when: false

- name: "Validation de la connexion au cluster"
  assert:
    that:
    - helm_cluster_test.rc == 0
    fail_msg: "Helm ne peut pas se connecter au cluster Kubernetes"
    success_msg: "Helm peut se connecter au cluster Kubernetes"

- name: "VÃ©rification que tous les repositories sont configurÃ©s"
  command: helm repo list
  register: configured_repos
  environment:
    KUBECONFIG: "{{ k3s_config_file | default('/etc/rancher/k3s/k3s.yaml') }}"
  become: true
  changed_when: false

- name: "Validation des repositories"
  assert:
    that:
    - item.name in configured_repos.stdout
    fail_msg: "Repository {{ item.name }} n'est pas configurÃ©"
    success_msg: "Repository {{ item.name }} configurÃ©"
  loop: "{{ helm_repositories }}"

- name: "Affichage du rÃ©sumÃ© Helm"
  debug:
    msg: |
      âœ… Helm installÃ© et configurÃ© avec succÃ¨s!

      ğŸ“¦ Version: {{ helm_version }}
      ğŸ—‚ï¸  Repositories configurÃ©s: {{ helm_repositories | length }}
      ğŸ”— Connexion cluster: âœ…

      ğŸš€ PrÃªt pour dÃ©ployer des charts Helm!
