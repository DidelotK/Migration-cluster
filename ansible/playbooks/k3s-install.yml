---
# Playbook principal pour l'installation complète de K3s
- name: "🚀 Installation et configuration complète de K3s"
  hosts: k3s_servers
  become: true
  gather_facts: true
  serial: 1 # Installation séquentielle pour éviter les conflits

  pre_tasks:
  - name: "📋 Vérification des prérequis"
    assert:
      that:
      - ansible_os_family == "Debian"
      - ansible_distribution_major_version|int >= 20
      fail_msg: "Ce playbook nécessite Ubuntu 20.04+ ou Debian 10+"
      success_msg: "OS compatible détecté: {{ ansible_distribution }} {{ ansible_distribution_version }}"

  - name: "🔍 Affichage des informations système"
    debug:
      msg: |
        🖥️  Hôte: {{ inventory_hostname }}
        🌐 IP: {{ ansible_default_ipv4.address }}
        💾 RAM: {{ ansible_memtotal_mb }}MB
        💿 OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
        🏗️  Architecture: {{ ansible_architecture }}

  roles:
  - role: k3s
    tags: [ k3s ]

  - role: helm
    tags: [ helm ]

  post_tasks:
  - name: "✅ Résumé de l'installation"
    debug:
      msg: |
        🎉 Installation K3s terminée avec succès!

        📊 Informations du cluster:
        - Nom: {{ instance_name | default('k3s-cluster') }}
        - IP: {{ ansible_default_ipv4.address }}
        - Version K3s: {{ k3s_version }}
        - Version Helm: {{ helm_version }}

        🔑 Accès:
        - SSH: ssh root@{{ ansible_default_ipv4.address }}
        - Kubeconfig: {{ k3s_config_file }}

        🚀 Prochaines étapes:
        1. Configurer External DNS
        2. Installer Cert Manager
        3. Installer Ingress NGINX
        4. Déployer les applications
---
# Playbook pour l'installation des composants essentiels
- name: "🔧 Installation des composants essentiels"
  hosts: k3s_servers
  become: true
  gather_facts: false

  roles:
  - role: ingress-nginx
    tags: [ ingress-nginx, networking ]

  - role: cert-manager
    tags: [ cert-manager, ssl ]

  - role: external-dns
    tags: [ external-dns, dns ]

  - role: external-secrets
    tags: [ external-secrets, secrets ]

  post_tasks:
  - name: "🏁 Installation complète terminée"
    debug:
      msg: |
        🎊 Cluster K3s prêt pour la production!

        ✅ Composants installés:
        - K3s {{ k3s_version }}
        - Helm {{ helm_version }}
        - Ingress NGINX
        - Cert Manager
        - External DNS
        - External Secrets

        🔗 Votre cluster est maintenant prêt à recevoir des applications!
