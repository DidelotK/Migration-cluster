---
# Playbook principal pour l'installation complÃ¨te de K3s
- name: "ğŸš€ Installation et configuration complÃ¨te de K3s"
  hosts: k3s_servers
  become: true
  gather_facts: true
  serial: 1 # Installation sÃ©quentielle pour Ã©viter les conflits

  pre_tasks:
  - name: "ğŸ“‹ VÃ©rification des prÃ©requis"
    assert:
      that:
      - ansible_os_family == "Debian"
      - ansible_distribution_major_version|int >= 20
      fail_msg: "Ce playbook nÃ©cessite Ubuntu 20.04+ ou Debian 10+"
      success_msg: "OS compatible dÃ©tectÃ©: {{ ansible_distribution }} {{ ansible_distribution_version }}"

  - name: "ğŸ” Affichage des informations systÃ¨me"
    debug:
      msg: |
        ğŸ–¥ï¸  HÃ´te: {{ inventory_hostname }}
        ğŸŒ IP: {{ ansible_default_ipv4.address }}
        ğŸ’¾ RAM: {{ ansible_memtotal_mb }}MB
        ğŸ’¿ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
        ğŸ—ï¸  Architecture: {{ ansible_architecture }}

  roles:
  - role: k3s
    tags: [ k3s ]

  - role: helm
    tags: [ helm ]

  post_tasks:
  - name: "âœ… RÃ©sumÃ© de l'installation"
    debug:
      msg: |
        ğŸ‰ Installation K3s terminÃ©e avec succÃ¨s!

        ğŸ“Š Informations du cluster:
        - Nom: {{ instance_name | default('k3s-cluster') }}
        - IP: {{ ansible_default_ipv4.address }}
        - Version K3s: {{ k3s_version }}
        - Version Helm: {{ helm_version }}

        ğŸ”‘ AccÃ¨s:
        - SSH: ssh root@{{ ansible_default_ipv4.address }}
        - Kubeconfig: {{ k3s_config_file }}

        ğŸš€ Prochaines Ã©tapes:
        1. Configurer External DNS
        2. Installer Cert Manager
        3. Installer Ingress NGINX
        4. DÃ©ployer les applications
---
# Playbook pour l'installation des composants essentiels
- name: "ğŸ”§ Installation des composants essentiels"
  hosts: k3s_servers
  become: true
  gather_facts: false

  roles:
  - role: ingress-nginx
    tags: [ ingress-nginx, networking ]

  - role: cert-manager
    tags: [ cert-manager, ssl ]

  - role: external-dns
    tags: [ external-dns, dns ]

  - role: external-secrets
    tags: [ external-secrets, secrets ]

  post_tasks:
  - name: "ğŸ Installation complÃ¨te terminÃ©e"
    debug:
      msg: |
        ğŸŠ Cluster K3s prÃªt pour la production!

        âœ… Composants installÃ©s:
        - K3s {{ k3s_version }}
        - Helm {{ helm_version }}
        - Ingress NGINX
        - Cert Manager
        - External DNS
        - External Secrets

        ğŸ”— Votre cluster est maintenant prÃªt Ã  recevoir des applications!
