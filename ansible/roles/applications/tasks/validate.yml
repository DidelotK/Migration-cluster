---
# Validation des applications

- name: "ğŸ” VÃ©rification du statut des pods Nginx test"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: nginx-test
    label_selectors:
    - app=nginx-test
  register: nginx_test_pods

- name: "ğŸ“Š Validation des pods Nginx test"
  assert:
    that:
    - nginx_test_pods.resources | length == 2
    - nginx_test_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == 2
    fail_msg: "âŒ Les pods Nginx test ne sont pas tous en Ã©tat Running"
    success_msg: "âœ… Tous les pods Nginx test sont en Ã©tat Running"

- name: "ğŸ” VÃ©rification de l'Ingress"
  kubernetes.core.k8s_info:
    api_version: networking.k8s.io/v1
    kind: Ingress
    name: nginx-test-ingress
    namespace: nginx-test
  register: nginx_ingress

- name: "ğŸ” VÃ©rification du certificat SSL"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: nginx-test-tls
    namespace: nginx-test
  register: nginx_tls_secret

- name: "ğŸŒ Test de connectivitÃ© HTTP (redirection SSL)"
  uri:
    url: "http://51.158.76.126"
    method: GET
    timeout: 30
    status_code: [ 301, 302, 308, 404 ] # Redirections SSL ou 404 avant DNS
    headers:
      Host: "nginx.keltio.fr"
  register: http_test
  retries: 3
  delay: 10
  failed_when: false

- name: "ğŸ” Test de connectivitÃ© HTTPS"
  uri:
    url: "https://51.158.76.126"
    method: GET
    timeout: 30
    status_code: [ 200, 404 ]
    headers:
      Host: "nginx.keltio.fr"
    validate_certs: false # Car on teste avec l'IP et non le domaine
  register: https_test
  retries: 3
  delay: 10
  failed_when: false

- name: "âœ… Validation complÃ¨te des applications"
  debug:
    msg: |
      ğŸ‰ Applications validÃ©es avec succÃ¨s!

      ğŸ“Š Statut Nginx Test:
      - Pods en cours: {{ nginx_test_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}/{{ nginx_test_pods.resources | length }}
      - Ingress configurÃ©: {{ 'âœ…' if nginx_ingress.resources | length > 0 else 'âŒ' }}
      - Certificat SSL: {{ 'âœ…' if nginx_tls_secret.resources | length > 0 else 'ğŸ”„ En cours de gÃ©nÃ©ration' }}

      ğŸŒ Tests de connectivitÃ©:
      - HTTP (redirection): {{ 'âœ…' if http_test.status in [301, 302, 308] else 'âŒ' }}
      - HTTPS: {{ 'âœ…' if https_test.status == 200 else 'âŒ' }}

      ğŸš€ Application accessible sur: https://nginx.keltio.fr

      ğŸ’¡ Note: Le DNS peut prendre quelques minutes Ã  se propager.
           External DNS synchronise automatiquement les enregistrements.
