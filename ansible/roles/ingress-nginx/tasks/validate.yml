---
# Validation d'Ingress Nginx

- name: "ğŸ” VÃ©rification du statut des pods Ingress Nginx"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: ingress-nginx
    label_selectors:
    - app.kubernetes.io/name=ingress-nginx
  register: ingress_pods

- name: "ğŸ“Š Validation des pods Ingress Nginx"
  assert:
    that:
    - ingress_pods.resources | length > 0
    - ingress_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == ingress_pods.resources | length
    fail_msg: "âŒ Tous les pods Ingress Nginx ne sont pas en Ã©tat Running"
    success_msg: "âœ… Tous les pods Ingress Nginx sont en Ã©tat Running"

- name: "ğŸŒ Test de connectivitÃ© du service"
  uri:
    url: "http://{{ public_ip }}/healthz"
    method: GET
    timeout: 30
    status_code: [ 200, 404 ] # 404 est normal car pas d'Ingress configurÃ© encore
  register: health_check
  retries: 3
  delay: 10

- name: "âœ… Validation du health check"
  debug:
    msg: |
      ğŸ‰ Ingress Nginx validÃ© avec succÃ¨s!

      ğŸ“Š Statut:
      - Pods en cours: {{ ingress_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}/{{ ingress_pods.resources | length }}
      - Health check: {{ health_check.status }} ({{ health_check.msg | default('OK') }})
      - URL d'accÃ¨s: http://{{ public_ip }}

      ğŸš€ PrÃªt pour les Ingress rules!
