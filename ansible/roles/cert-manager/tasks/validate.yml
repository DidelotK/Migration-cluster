---
# Validation de Cert Manager

- name: "ğŸ” VÃ©rification du statut des pods Cert Manager"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: cert-manager
    label_selectors:
    - app.kubernetes.io/instance=cert-manager
  register: cert_manager_pods

- name: "ğŸ“Š Validation des pods Cert Manager"
  assert:
    that:
    - cert_manager_pods.resources | length >= 3 # cert-manager, webhook, cainjector
    - cert_manager_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == cert_manager_pods.resources | length
    fail_msg: "âŒ Tous les pods Cert Manager ne sont pas en Ã©tat Running"
    success_msg: "âœ… Tous les pods Cert Manager sont en Ã©tat Running"

- name: "ğŸ” VÃ©rification des ClusterIssuers"
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: ClusterIssuer
  register: cluster_issuers

- name: "ğŸ”‘ Validation des ClusterIssuers"
  assert:
    that:
    - cluster_issuers.resources | length >= 3
    - cluster_issuers.resources | selectattr('metadata.name', 'equalto', 'letsencrypt-prod') | list | length == 1
    - cluster_issuers.resources | selectattr('metadata.name', 'equalto', 'letsencrypt-staging') | list | length == 1
    - cluster_issuers.resources | selectattr('metadata.name', 'equalto', 'selfsigned-issuer') | list | length == 1
    fail_msg: "âŒ Les ClusterIssuers ne sont pas correctement configurÃ©s"
    success_msg: "âœ… Tous les ClusterIssuers sont configurÃ©s"

- name: "âœ… Validation complÃ¨te de Cert Manager"
  debug:
    msg: |
      ğŸ‰ Cert Manager validÃ© avec succÃ¨s!

      ğŸ“Š Statut:
      - Pods en cours: {{ cert_manager_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}/{{ cert_manager_pods.resources | length }}
      - ClusterIssuers: {{ cluster_issuers.resources | length }}

      ğŸ”‘ ClusterIssuers disponibles:
      {% for issuer in cluster_issuers.resources %}
      - {{ issuer.metadata.name }}: {{ issuer.status.conditions[0].type if issuer.status.conditions else 'Initializing' }}
      {% endfor %}

      ğŸš€ PrÃªt pour la gÃ©nÃ©ration automatique de certificats SSL!
